# 物联网操作系统(IoT OS)项目构想

[TOC]

## 往届 IoT OS 相关项目调研

目前，物联网操作系统主要分为两大类，一是由传统的嵌入式实时操作系统(RTOS)发展而来，比如FreeRTOS、LiteOS、RT-Thread；二是由互联网公司的云平台延伸而来，基于传统操作系统进行“剪裁”和定制的IoT OS，比如Ali OS Things、TencentOS tiny、Win10 IOT。往届IoT OS相关项目主要关注的是前者，还没有人关注后者。

下面是对往届两个 IoT OS 相关项目相关工作的调研。

### 2019 x-rust-freertos

[该项目](https://github.com/OSH-2019/x-rust-freertos)是利用Rust语言改写FreeRTOS操作系统。在该项目中，小组成员按照FreeRTOS的程序逻辑，针对Rust语言的特点做出了一些富有创造力的设计。最终该项目完成了6000多行代码，几乎实现了FreeRTOS的所有功能，在使用Rust改写的过程中，该小组遇到了很多Rust语言特性带来的困难，比如Rust不鼓励使用全局变量，他们在消灭全局变量的过程中遇到了很多麻烦；还有改写C语言的指针时遇到的麻烦，他们的代码中使用了过多智能指针，这就导致这些指针基于操作系统的信号量机制，容易造成死锁。

总的来看，该项目需要：

- 前期花费精力学习Rust这门大家接触较少的语言；
- 阅读已有的操作系统的源代码，弄明白该系统各层面的实现机制；
- 使用新学习的语言重写已有的操作系统，并在发现原实现机制无法复现时，找出相应的改写方案。

### 2021 x-RIG

[该项目](https://github.com/OSH-2021/x-RIG)以 `FreeRTOS` 为依据，主要完成以下3项内容：

1. 进行FreeRTOS的Rust版本迭代(在2019年的x-rust-freertos的基础上迭代)；

2. 将seL4的 `capability` 机制添加到 FreeRTOS 中；

3. 通过可加载模块实现FreeRTOS在多核处理器（如树莓派）上运行。

第一项工作的依据：19年项目改写的FreeRTOS的版本是9.0版，该版本发行于2016年，而x-RIG项目组创建项目时，FreeRTOS已经更新到10.4版，所以该组对19年项目进行更新迭代，添加stream buffer模块；

第二项工作的依据：FreeRTOS并没有安全模型，而该操作系统在物联网中应用十分广泛，再加之嵌入式设备逐步连入网络的趋势，安全性问题亟待解决，因此该小组便考虑为FreeRTOS引入一个基于 seL4's capability 的 security model，提高FreeRTOS面对威胁时的防御力，保证其安全性；

第三项工作的依据：早期的嵌入式处理器运算能力低，而随着大规模集成电路技术的发展和摩尔定律的驱使，嵌入式处理器的性能越来越强，从而嵌入式应用也日趋复杂，反过来对嵌入式处理器性能的要求也越来越高。该小组在多核架构上实现FreeRTOS，意在满足对嵌入式系统不断增长的需求。

总的来看，该项目需要：

- 前期花费精力学习Rust这门大家接触较少的语言；
- 学习FreeRTOS的框架并掌握版本更新的内容，从而对Rust版FreeRTOS要更新实现的内容有所了解；
- 学习seL4框架，对seL4的capability机制进行学习，并将其移植到FreeRTOS中。

### 往届 IoT OS 相关项目调研小结

往届物联网操作系统相关项目只有两个，而这两个又都与FreeRTOS相关，和分布式文件系统以及 Unikernel 这两个方向相比，这个方向算是冷门方向。

第一个项目x-rust-freertos算是开创性的一个项目，使用更加安全的Rust语言对已有的物联网操作系统进行改写，提升其安全性。毕竟已经有了 FreeRTOS 的源码架构，该项目在真正掌握Rust后实现起来并不是一件十分困难的事情，而难点就在于大家对Rust接触不多，需要从头学习，还要求即学即用，这也是一件十分富有挑战性的事情。

第二个项目则是在前一个项目的基础上进行了版本迭代，添加了新模块的Rust实现，毕竟已经有了前人的改写经历，因此单就版本迭代这一任务，难度并不大，只是也需要大家对Rust语言进行学习，但好在已经有前人的Rust改写代码，学习成本也会相应降低；此外该项目还考虑到FreeRTOS的安全性问题，创造性地将其他微内核中的安全机制引入到FreeRTOS中去，这种创造性思维很难得。

## IoT OS 项目构想

### 构想依据

#### TencentOS Tiny

TencentOS Tiny 是腾讯面向物联网领域开发的实时操作系统，具有低功耗，低资源占用，模块化，安全可靠等特点，可有效提升物联网终端产品开发效率。目前该操作系统已经在[github开源](https://github.com/OpenAtomFoundation/TencentOS-tiny)，且官方团队在github上提供了许多[相关学习资料](https://github.com/OpenAtomFoundation/TencentOS-tiny#%E4%B9%9D%E7%AC%AC%E4%B8%89%E6%96%B9%E5%BC%80%E5%8F%91%E8%80%85%E8%AF%84%E6%B5%8B)，比较方便学习。

> TencentOS tiny 提供精简的 RTOS 内核，内核组件可裁剪可配置，可快速移植到多种主流 MCU (如 STM32 全系列)及模组芯片上。而且，基于 RTOS 内核提供了丰富的物联网组件，内部集成主流物联网协议栈（如CoAP/MQTT/TLS/DTLS/LoRaWAN/NB-IoT等），可助力物联网终端设备及业务快速接入腾讯云物联网平台。

#### MS-RTOS

MS-RTOS (Micro Safe RTOS) 是翼辉信息全新设计的一款面向未来的安全实时操作系统，其最大的特点是**开创性地在没有 MMU 和资源受限的 MCU**（如Cortex-M3）**上也能支持多进程与动态装载技术**，使得应用与系统能分离开发、独立升级；MS-RTOS **支持内核空间内存保护**（应用程序通过 syscall 访问内核），使得内核有着非常高的安全性。MS-RTOS 在提供足够丰富功能的同时，保持了高效简洁的实现，对 ROM、RAM 消耗极低，特别适用于对硬件成本敏感、安全性要求特别高的产品。

>**多进程**：
>允许运行多个进程，进程用户代码工作在 CPU 用户态，通过系统调用（syscall）访问内核资源，利用 MPU 实现进程地址空间相互隔离。
>
>**动态装载**：
>驱动与应用程序分离开发，应用与系统独立升级，应用程序直接在 FLASH 中运行（无需加载到 RAM 执行，节约 RAM，运行速度更快）。
>
>**内核安全**：
>进程用户代码工作在 CPU 用户态，通过系统调用（syscall）进入内核, 保护内核不被进程破坏，利用 MPU 做到进程地址空间相互隔离, 进程影响范围最小化，掉电安全文件系统。

目前该操作系统只是对部分中间件在[github](https://github.com/ms-rtos)和[gitee](https://gitee.com/ms-rtos)上开源，并没有全部开源。

### 构想内容

能否将MS-RTOS的鲜明特点移植到TencentOS Tiny中去，从而将二者的优点合并，得到一个更加优越的物联网操作系统呢？与此同时，能不能优化MS-RTOS的安全机制使得新的物联网操作系统在当今时代变得更加安全呢？这两个项目都是用C语言实现的，如果有必要，能不能使用Rust对其进行改写从而得到更加安全的代码呢？

以上便是我的一些初步构想内容。

## IoT OS 相关参考资料

- [Open Source RTOS List](https://www.osrtos.com/)
- [TencentOS Tiny——Github](https://github.com/OpenAtomFoundation/TencentOS-tiny)
- [MS-RTOS——Github](https://github.com/ms-rtos)
- [MS-RTOS——Gitee](https://gitee.com/ms-rtos)
- [主流物联网操作系统介绍——电子工程专辑](https://www.eet-china.com/news/202105180818.html)

- [MS-RTOS正式发布啦！！！——CSDN博客](https://blog.csdn.net/ScilogyHunter/article/details/107390947)

- [什么是实时操作系统(RTOS)——知乎专栏](https://zhuanlan.zhihu.com/p/86861756)
- [何小庆的presentations主页](https://www.hexiaoqing.net/presentations/)
  - [物联网操作系统研究与思考(2017.6)](https://www.hexiaoqing.net/wp-content/uploads/2016/05/%E7%89%A9%E8%81%94%E7%BD%91%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%A0%94%E7%A9%B6%E4%B8%8E%E6%80%9D%E8%80%83-201706.pdf)
  - [物联网操作系统:技术、应用与发展(2018.4)](https://www.hexiaoqing.net/wp-content/uploads/2016/05/%E7%89%A9%E8%81%94%E7%BD%91%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-%E6%8A%80%E6%9C%AF%E5%BA%94%E7%94%A8%E4%B8%8E%E5%8F%91%E5%B1%95-201804.pdf)
  - [三种物联网操作系统分析与比较(2019.3)](https://www.hexiaoqing.net/wp-content/uploads/2016/05/%E4%B8%89%E7%A7%8D%E7%89%A9%E8%81%94%E7%BD%91%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%88%86%E6%9E%90%E4%B8%8E%E6%AF%94%E8%BE%83-%E4%B8%8A%E6%B5%B7%E6%85%95%E5%B0%BC%E9%BB%91%E7%94%B5%E5%AD%90%E5%B1%95-201903.pdf)
  - [物联网操作系统的过去、现在与未来(2021.8)](https://www.esbf.org/wp-content/uploads/2021/08/202108_PPT_HXQ.pdf)
- [何小庆的articles主页](https://www.hexiaoqing.net/articles/)
  - [单片机与嵌入式系统应用杂志卷首语(2021.2)-物联网操作系统展望](https://www.hexiaoqing.net/wp-content/uploads/2016/05/%E5%8D%B7%E9%A6%96%E8%AF%AD-%E7%89%A9%E8%81%94%E7%BD%91%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%B1%95%E6%9C%9B-202102.pdf)
  - [构建基于MCU安全物联网系统](http://epaper.cena.com.cn/content/1/2019-11/08/08/2019110808_pdf.pdf)
